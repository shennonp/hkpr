<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hokku PR — Media Database</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --ink:#0A0A0F;--paper:#F5F3EE;--cream:#EDE9E0;--mid:#C8C2B4;--steel:#6B6560;
  --red:#C8372D;--red-bg:#FBF0EF;
  --amber:#C47B1A;--amber-bg:#FBF5EA;
  --green:#1E7A4C;--green-bg:#EDF7F2;
  --blue:#1A4BAD;--blue-bg:#EDF2FB;
  --purple:#6B34AD;--purple-bg:#F3EEF9;
  --teal:#0E7490;--teal-bg:#EEF9FB;
  --border:rgba(10,10,15,0.10);
}
html,body{background:var(--paper);color:var(--ink);font-family:'DM Sans',sans-serif;font-size:14px;min-height:100vh}

/* HEADER */
header{background:var(--ink);padding:16px 28px;display:flex;align-items:center;gap:14px;border-bottom:3px solid var(--red);position:sticky;top:0;z-index:50}
header h1{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#fff;letter-spacing:-0.02em}
.sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--mid);letter-spacing:0.1em;text-transform:uppercase}
.hdr-right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* TABS */
.tab-bar{display:flex;gap:0;padding:0 28px;background:var(--ink);border-bottom:3px solid var(--red);margin-top:-3px;position:sticky;top:63px;z-index:49}
.tab{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;padding:10px 18px;color:var(--mid);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-3px;transition:all .15s;user-select:none}
.tab:hover{color:#fff}
.tab.active{color:#fff;border-bottom-color:var(--red)}

/* sync indicator */
.sync-pill{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.04em;color:var(--mid);border:1px solid rgba(255,255,255,0.12);padding:5px 10px;border-radius:3px;white-space:nowrap}
.sync-pill .dot{width:7px;height:7px;border-radius:50%;background:var(--mid);transition:background .3s;flex-shrink:0}
.sync-pill.live .dot{background:#4ade80;box-shadow:0 0 5px #4ade8066}
.sync-pill.live{color:#4ade80;border-color:rgba(74,222,128,0.25)}
.sync-pill.saving .dot{background:var(--amber);animation:pulse 1s infinite}
.sync-pill.error .dot{background:var(--red)}
.sync-pill.error{color:var(--red);border-color:rgba(200,55,45,0.3)}
.sync-pill.offline .dot{background:var(--steel)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.hbtn{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.05em;text-transform:uppercase;padding:7px 12px;border-radius:3px;cursor:pointer;border:1.5px solid;transition:all .15s;white-space:nowrap;line-height:1}
.hbtn-count{font-family:'DM Mono',monospace;font-size:10px;color:var(--mid);letter-spacing:0.05em;border:1px solid rgba(255,255,255,0.12);padding:5px 10px;border-radius:3px}
.btn-add{color:#fff;border-color:var(--red);background:var(--red)}
.btn-add:hover{background:#a82820}
.btn-bulk{color:var(--amber);border-color:var(--amber);background:none}
.btn-bulk:hover{background:var(--amber);color:#fff}
.btn-ghost{color:var(--mid);border-color:rgba(255,255,255,0.15);background:none}
.btn-ghost:hover{color:#fff;border-color:#fff}
.btn-setup-hdr{color:var(--mid);border-color:rgba(255,255,255,0.15);background:none}
.btn-setup-hdr:hover{color:#fff;border-color:#fff}

/* LAYOUT */
.layout{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 103px)}
.page{display:none}.page.active{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 103px)}

/* SIDEBAR */
.sidebar{background:var(--cream);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;max-height:calc(100vh - 103px);position:sticky;top:103px}
.fg label{display:block;font-family:'Syne',sans-serif;font-weight:700;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:var(--steel);margin-bottom:7px}
.chip-group{display:flex;flex-wrap:wrap;gap:5px}
.chip{font-family:'DM Mono',monospace;font-size:11px;padding:4px 8px;border-radius:3px;border:1.5px solid var(--border);background:var(--paper);color:var(--steel);cursor:pointer;transition:all .12s;user-select:none}
.chip:hover{border-color:var(--ink);color:var(--ink)}
.chip.on{background:var(--ink);border-color:var(--ink);color:#fff}
.chip.all.on{background:var(--red);border-color:var(--red)}
.div{height:1px;background:var(--border)}
.clr-btn{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.05em;text-transform:uppercase;color:var(--red);background:none;border:1.5px solid var(--red);border-radius:3px;padding:7px;cursor:pointer;width:100%;transition:all .15s}
.clr-btn:hover{background:var(--red);color:#fff}
.sw{position:relative}
.sw input{width:100%;font-family:'DM Mono',monospace;font-size:12px;padding:8px 10px 8px 29px;border:1.5px solid var(--border);border-radius:3px;background:var(--paper);color:var(--ink);outline:none;transition:border-color .15s}
.sw input:focus{border-color:var(--ink)}
.sw::before{content:'⌕';position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--steel);font-size:15px;pointer-events:none}

/* MAIN */
.main{display:flex;flex-direction:column}
.rbar{padding:10px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--paper);flex-wrap:wrap}
.rcount{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;white-space:nowrap}
.rcount span{font-family:'DM Mono',monospace;font-size:18px;color:var(--red);margin-right:3px}
.pills{display:flex;gap:5px;flex-wrap:wrap;flex:1;min-width:0}
.pill{font-family:'DM Mono',monospace;font-size:10px;padding:3px 7px;background:var(--ink);color:#fff;border-radius:2px}
.exp-group{display:flex;gap:6px;margin-left:auto}
.ebtn{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.04em;text-transform:uppercase;border-radius:3px;padding:6px 11px;cursor:pointer;border:1.5px solid;transition:all .15s;white-space:nowrap}
.btn-csv{color:var(--green);border-color:var(--green);background:var(--green-bg)}
.btn-csv:hover{background:var(--green);color:#fff}
.btn-cp{color:var(--blue);border-color:var(--blue);background:var(--blue-bg)}
.btn-cp:hover{background:var(--blue);color:#fff}

/* TABLE */
.tw{flex:1;overflow:auto;padding:16px 24px 40px}
table{width:100%;border-collapse:collapse}
thead th{font-family:'Syne',sans-serif;font-weight:700;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--steel);text-align:left;padding:8px 10px;border-bottom:2px solid var(--ink);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--cream)}
tbody td{padding:10px 10px;font-size:13px;vertical-align:middle}
td.n{font-weight:500}
td.em{font-family:'DM Mono',monospace;font-size:11px;color:var(--blue);word-break:break-all}
td.nt{font-size:12px;color:var(--steel)}
.tag{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;padding:2px 6px;border-radius:2px;white-space:nowrap;margin:1px}
.ts{background:var(--blue-bg);color:var(--blue);border:1px solid rgba(26,75,173,0.18)}
.tc{background:var(--amber-bg);color:var(--amber);border:1px solid rgba(196,123,26,0.18)}
.tt{background:var(--green-bg);color:var(--green);border:1px solid rgba(30,122,76,0.18)}
.tp{background:var(--purple-bg);color:var(--purple);border:1px solid rgba(107,52,173,0.18)}
.tq{background:var(--teal-bg);color:var(--teal);border:1px solid rgba(14,116,144,0.18)}
.tier1{background:#FFF8E1;color:#B45309;border:1px solid rgba(180,83,9,0.25);font-weight:600}
.tier2{background:var(--blue-bg);color:var(--blue);border:1px solid rgba(26,75,173,0.18)}
.tier3{background:var(--cream);color:var(--steel);border:1px solid var(--border)}
.act-btns{display:flex;gap:5px;opacity:0;transition:opacity .15s}
tbody tr:hover .act-btns{opacity:1}
.act-btn{font-family:'DM Mono',monospace;font-size:10px;padding:3px 7px;border-radius:2px;cursor:pointer;border:1px solid;transition:all .12s;background:none}
.btn-edit{color:var(--blue);border-color:var(--blue)}
.btn-edit:hover{background:var(--blue);color:#fff}
.btn-del{color:var(--red);border-color:var(--red)}
.btn-del:hover{background:var(--red);color:#fff}

/* tags list cell */
.tags-cell{display:flex;flex-wrap:wrap;gap:2px;max-width:180px}

/* EMPTY */
.empty{display:none;flex-direction:column;align-items:center;justify-content:center;padding:70px 40px;text-align:center;gap:12px}
.empty.on{display:flex}
.ei{font-size:36px;opacity:.3}
.empty h3{font-family:'Syne',sans-serif;font-weight:700;font-size:15px}
.empty p{font-size:13px;color:var(--steel);max-width:290px;line-height:1.6}

/* MODAL BASE */
.mb{position:fixed;inset:0;background:rgba(10,10,15,0.6);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(2px)}
.mb.on{opacity:1;pointer-events:all}
.md{background:var(--paper);border-radius:6px;width:580px;max-width:96vw;max-height:92vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,0.3)}
.md-lg{width:700px}
.md-xl{width:640px}
.mh{background:var(--ink);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;border-radius:6px 6px 0 0;position:sticky;top:0;z-index:2}
.mh h2{font-family:'Syne',sans-serif;font-weight:800;font-size:14px;color:#fff}
.mc{background:none;border:none;color:var(--mid);font-size:20px;cursor:pointer;transition:color .15s;line-height:1}
.mc:hover{color:#fff}
.mb-body{padding:22px;display:flex;flex-direction:column;gap:14px}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid .full{grid-column:1/-1}
.field label{display:block;font-family:'Syne',sans-serif;font-weight:700;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--steel);margin-bottom:5px}
.field input,.field select,.field textarea{width:100%;font-family:'DM Mono',monospace;font-size:12px;padding:8px 10px;border:1.5px solid var(--border);border-radius:3px;background:#fff;color:var(--ink);outline:none;transition:border-color .15s;-webkit-appearance:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue)}
.field textarea{resize:vertical;min-height:60px;font-family:'DM Sans',sans-serif;font-size:13px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding-top:4px}
.btn-primary{font-family:'DM Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;background:var(--ink);color:#fff;border:none;border-radius:3px;padding:9px 16px;cursor:pointer;transition:background .15s}
.btn-primary:hover{background:#222}
.btn-secondary{font-family:'DM Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;background:none;color:var(--steel);border:1.5px solid var(--border);border-radius:3px;padding:9px 12px;cursor:pointer;transition:all .15s}
.btn-secondary:hover{border-color:var(--ink);color:var(--ink)}
.btn-danger{font-family:'DM Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;background:var(--red);color:#fff;border:none;border-radius:3px;padding:9px 12px;cursor:pointer;transition:background .15s;margin-right:auto}
.btn-danger:hover{background:#a82820}

/* multi-tag input */
.tag-input-wrap{display:flex;flex-wrap:wrap;gap:5px;padding:7px 10px;border:1.5px solid var(--border);border-radius:3px;background:#fff;min-height:38px;cursor:text;transition:border-color .15s}
.tag-input-wrap:focus-within{border-color:var(--blue)}
.tag-input-wrap .ti-tag{display:flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:11px;padding:2px 7px;border-radius:2px;background:var(--ink);color:#fff}
.tag-input-wrap .ti-tag button{background:none;border:none;color:var(--mid);cursor:pointer;font-size:13px;line-height:1;padding:0}
.tag-input-wrap .ti-tag button:hover{color:#fff}
.tag-input-wrap input{border:none;outline:none;font-family:'DM Mono',monospace;font-size:12px;flex:1;min-width:80px;background:transparent;color:var(--ink)}
.tag-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--steel);margin-top:4px}

/* BULK */
.bulk-info{background:var(--blue-bg);border-radius:4px;padding:13px;font-size:12.5px;color:var(--steel);line-height:1.65}
.bulk-info code{font-family:'DM Mono',monospace;font-size:11px;background:rgba(26,75,173,0.1);padding:2px 5px;border-radius:2px;color:var(--blue)}
.bulk-ta{width:100%;font-family:'DM Mono',monospace;font-size:12px;padding:11px;border:1.5px solid var(--border);border-radius:3px;background:#fff;color:var(--ink);outline:none;resize:vertical;min-height:180px;line-height:1.7;transition:border-color .15s}
.bulk-ta:focus{border-color:var(--blue)}
.preview-label{font-family:'DM Mono',monospace;font-size:11px;color:var(--steel);margin-bottom:7px;letter-spacing:0.04em}
.preview-table{width:100%;border-collapse:collapse;font-size:12px;max-height:160px;display:block;overflow-y:auto}
.preview-table th{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:var(--steel);padding:5px 9px;border-bottom:1.5px solid var(--ink);text-align:left;background:var(--cream);position:sticky;top:0}
.preview-table td{padding:5px 9px;border-bottom:1px solid var(--border);color:var(--ink)}
.preview-err{color:var(--red);font-family:'DM Mono',monospace;font-size:11px;margin-top:5px}
.preview-ok{color:var(--green);font-family:'DM Mono',monospace;font-size:11px;margin-top:5px}

/* SETUP MODAL */
.step{display:flex;gap:13px;align-items:flex-start}
.step-num{width:24px;height:24px;border-radius:50%;background:var(--ink);color:#fff;font-family:'Syne',sans-serif;font-weight:800;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.step-content h4{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;margin-bottom:5px}
.step-content p{font-size:12.5px;color:var(--steel);line-height:1.65}
code{font-family:'DM Mono',monospace;font-size:11px;background:var(--cream);padding:2px 5px;border-radius:2px;color:var(--ink)}
.key-wrap{display:flex;gap:7px;margin-top:9px}
.key-wrap input{flex:1;font-family:'DM Mono',monospace;font-size:12px;padding:9px 10px;border:1.5px solid var(--border);border-radius:3px;outline:none;background:#fff;transition:border-color .15s}
.key-wrap input:focus{border-color:var(--blue)}
.key-wrap input[type=password]{letter-spacing:0.1em}
.btn-connect{font-family:'DM Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;background:var(--blue);color:#fff;border:none;border-radius:3px;padding:9px 14px;cursor:pointer;white-space:nowrap;transition:background .15s}
.btn-connect:hover{background:#0f3485}
.conn-status{font-family:'DM Mono',monospace;font-size:11px;margin-top:7px}
.conn-status.ok{color:var(--green)}
.conn-status.err{color:var(--red)}
.setup-note{background:var(--amber-bg);border-radius:4px;padding:12px 14px;font-size:12px;color:var(--amber);line-height:1.6;border-left:3px solid var(--amber)}


/* CHECKBOX SELECTION */
.cb-cell{width:32px;padding:8px 4px 8px 12px !important}
.cb-cell input[type=checkbox]{width:15px;height:15px;cursor:pointer;accent-color:var(--red)}
thead th.cb-cell{padding:8px 4px 8px 12px !important}
tbody tr.selected{background:var(--red-bg) !important}

/* BULK ACTION BAR */
.bulk-action-bar{display:none;align-items:center;gap:10px;padding:8px 24px;background:#fff8f7;border-bottom:2px solid var(--red);border-top:1px solid rgba(200,55,45,0.15)}
.bulk-action-bar.on{display:flex}
.bulk-sel-count{font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:var(--red)}
.btn-bulk-del{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.05em;text-transform:uppercase;background:var(--red);color:#fff;border:none;border-radius:3px;padding:7px 14px;cursor:pointer;transition:background .15s}
.btn-bulk-del:hover{background:#a82820}
.btn-bulk-cancel{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.05em;text-transform:uppercase;background:none;color:var(--steel);border:1.5px solid var(--border);border-radius:3px;padding:7px 12px;cursor:pointer;transition:all .15s}
.btn-bulk-cancel:hover{border-color:var(--ink);color:var(--ink)}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--ink);color:#fff;font-family:'DM Mono',monospace;font-size:12px;padding:10px 15px;border-radius:4px;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;z-index:500;max-width:340px;line-height:1.5}
.toast.on{opacity:1;transform:translateY(0)}
.toast.s{border-left:3px solid #4ade80}
.toast.e{border-left:3px solid var(--red)}
.toast.w{border-left:3px solid var(--amber)}

/* section label in sidebar */
.sec-label{font-family:'Syne',sans-serif;font-weight:800;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--mid);padding:2px 0}
</style>
</head>
<body>

<header>
  <h1>HOKKU PR</h1>
  <span class="sub">Media Database</span>
  <div class="hdr-right">
    <div class="sync-pill offline" id="syncPill">
      <span class="dot"></span>
      <span id="syncLabel">Not connected</span>
    </div>
    <span class="hbtn-count" id="totalBadge">0 records</span>
    <button class="hbtn btn-bulk"       id="bulkBtn"   onclick="openBulk()">⊞ Bulk Add</button>
    <button class="hbtn btn-add"        id="addBtn"    onclick="openAdd()">+ Add</button>
    <button class="hbtn btn-ghost"      id="exportBtn" onclick="exportAll()">↓ Backup</button>
    <button class="hbtn btn-setup-hdr"  onclick="openSetup()">⚙</button>
  </div>
</header>

<!-- TABS -->
<div class="tab-bar">
  <div class="tab active" id="tab-reporters" onclick="switchTab('reporters')">◎ Reporters</div>
  <div class="tab" id="tab-conferences" onclick="switchTab('conferences')">◈ Conferences</div>
</div>

<!-- ═══ REPORTERS PAGE ═══ -->
<div class="page active" id="page-reporters">
  <aside class="sidebar">
    <div class="fg"><label>Search</label><div class="sw"><input type="text" id="searchInput" placeholder="name, outlet, beat…"></div></div>
    <div class="div"></div>
    <div class="sec-label">Filters</div>
    <div class="fg"><label>Tier</label><div class="chip-group" id="tierChips"></div></div>
    <div class="fg"><label>Beat</label><div class="chip-group" id="beatChips"></div></div>
    <div class="fg"><label>Sector</label><div class="chip-group" id="sectorChips"></div></div>
    <div class="fg"><label>Country</label><div class="chip-group" id="countryChips"></div></div>
    <div class="fg"><label>Outlet Type</label><div class="chip-group" id="typeChips"></div></div>
    <div class="div"></div>
    <button class="clr-btn" onclick="clearAll()">↺ Clear filters</button>
  </aside>
  <div class="main">
    <div class="bulk-action-bar" id="bulkActionBar">
      <span class="bulk-sel-count"><span id="selCount">0</span> selected</span>
      <div id="selNormal" style="display:flex;gap:8px;align-items:center">
        <button class="btn-bulk-del" onclick="askDeleteSelected()">✕ Delete Selected</button>
        <button class="btn-bulk-cancel" onclick="clearSelection()">Cancel</button>
      </div>
      <div id="selConfirm" style="display:none;gap:8px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--red)">Sure? This cannot be undone.</span>
        <button class="btn-bulk-del" onclick="deleteSelected()">Yes, Delete</button>
        <button class="btn-bulk-cancel" onclick="cancelDeleteSelected()">No, Keep</button>
      </div>
    </div>
    <div class="rbar">
      <div class="rcount"><span id="matchCount">—</span> reporters</div>
      <div class="pills" id="activePills"></div>
      <div class="exp-group">
        <button class="ebtn btn-csv" onclick="exportCSV()">↓ CSV</button>
        <button class="ebtn btn-cp"  onclick="copyForSheets()">⎘ Copy for Sheets</button>
      </div>
    </div>
    <div class="tw">
      <div class="empty on" id="emptyState">
        <div class="ei">◎</div>
        <h3 id="emptyTitle">Not connected yet</h3>
        <p id="emptyMsg">Click ⚙ in the top right to connect your shared database. Takes 3 minutes to set up.</p>
      </div>
      <table id="tbl" style="display:none">
        <thead><tr>
          <th class="cb-cell"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th><th>Outlet</th><th>Reporter</th><th>Email</th><th>Tier</th><th>Beat</th><th>Sector</th><th>Type</th><th>Country</th><th>Notes</th><th></th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ CONFERENCES PAGE ═══ -->
<div class="page" id="page-conferences">
  <aside class="sidebar">
    <div class="fg"><label>Search</label><div class="sw"><input type="text" id="confSearchInput" placeholder="event name, organizer…"></div></div>
    <div class="div"></div>
    <div class="sec-label">Filters</div>
    <div class="fg"><label>Month</label><div class="chip-group" id="confMonthChips"></div></div>
    <div class="fg"><label>Audience</label><div class="chip-group" id="confAudienceChips"></div></div>
    <div class="fg"><label>Themes</label><div class="chip-group" id="confThemeChips"></div></div>
    <div class="div"></div>
    <button class="clr-btn" onclick="clearConfAll()">↺ Clear filters</button>
  </aside>
  <div class="main">
    <div class="bulk-action-bar" id="confBulkActionBar">
      <span class="bulk-sel-count"><span id="confSelCount">0</span> selected</span>
      <div id="confSelNormal" style="display:flex;gap:8px;align-items:center">
        <button class="btn-bulk-del" onclick="askDeleteConfSelected()">✕ Delete Selected</button>
        <button class="btn-bulk-cancel" onclick="clearConfSelection()">Cancel</button>
      </div>
      <div id="confSelConfirm" style="display:none;gap:8px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--red)">Sure? This cannot be undone.</span>
        <button class="btn-bulk-del" onclick="deleteConfSelected()">Yes, Delete</button>
        <button class="btn-bulk-cancel" onclick="cancelDeleteConfSelected()">No, Keep</button>
      </div>
    </div>
    <div class="rbar">
      <div class="rcount"><span id="confMatchCount">—</span> events</div>
      <div class="pills" id="confActivePills"></div>
      <div class="exp-group">
        <button class="ebtn btn-csv" onclick="exportConfCSV()">↓ CSV</button>
        <button class="ebtn btn-cp"  onclick="copyConfForSheets()">⎘ Copy for Sheets</button>
      </div>
    </div>
    <div class="tw">
      <div class="empty on" id="confEmptyState">
        <div class="ei">◈</div>
        <h3 id="confEmptyTitle">No conferences yet</h3>
        <p id="confEmptyMsg">Click + Add to log your first conference.</p>
      </div>
      <table id="confTbl" style="display:none">
        <thead><tr>
          <th class="cb-cell"><input type="checkbox" id="confSelectAll" onclick="toggleConfSelectAll()"></th><th>Month</th><th>Start Date</th><th>End Date</th><th>Event Name</th><th>Audience</th><th>Themes</th><th>Organizer Contact</th><th></th>
        </tr></thead>
        <tbody id="confTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ REPORTER ADD / EDIT MODAL ═══ -->
<div class="mb" id="addModal">
  <div class="md">
    <div class="mh"><h2 id="addModalTitle">+ Add Reporter</h2><button class="mc" onclick="closeAdd()">✕</button></div>
    <div class="mb-body">
      <div class="form-grid">
        <div class="field"><label>Name *</label><input id="f-name" type="text" placeholder="James Walker"></div>
        <div class="field"><label>Email *</label><input id="f-email" type="email" placeholder="j.walker@ft.com"></div>
        <div class="field"><label>Outlet</label><input id="f-outlet" type="text" placeholder="Financial Times"></div>
        <div class="field"><label>Tier</label>
          <select id="f-tier"><option value="">— select —</option><option>Tier 1</option><option>Tier 2</option><option>Tier 3</option></select>
        </div>
        <div class="field"><label>Beat</label>
          <select id="f-beat"><option value="">— select —</option><option>Markets</option><option>Funding News</option><option>Product News</option><option>Policy & Regulation</option><option>Technology</option><option>Crypto & DeFi</option><option>General Business</option></select>
        </div>
        <div class="field"><label>Sector</label>
          <select id="f-sector"><option value="">— select —</option><option>AI</option><option>Business</option><option>Markets</option><option>Finance</option><option>Crypto</option><option>Mainstream</option><option>Technology</option></select>
        </div>
        <div class="field"><label>Country</label>
          <select id="f-country"><option value="">— select —</option><option>UK</option><option>UAE</option><option>France</option><option>Germany</option><option>Switzerland</option><option>South Korea</option><option>Singapore</option><option>Hong Kong</option><option>Thailand</option><option>Japan</option><option>US</option><option>Other</option></select>
        </div>
        <div class="field"><label>Outlet Type</label>
          <select id="f-type"><option value="">— select —</option><option>Publication</option><option>Podcast</option><option>Broadcast</option><option>Magazine</option><option>Newsletter</option></select>
        </div>
        <div class="field full">
          <label>Themes <span style="font-weight:400;text-transform:none;letter-spacing:0">(type & press Enter or comma)</span></label>
          <div class="tag-input-wrap" id="themeTagWrap" onclick="document.getElementById('themeTagInput').focus()">
            <input type="text" id="themeTagInput" placeholder="e.g. Fintech, DeFi, Web3…">
          </div>
          <div class="tag-hint">Press Enter or comma to add each theme</div>
          <input type="hidden" id="f-themes">
        </div>
        <div class="field full"><label>Notes</label><textarea id="f-notes" placeholder="e.g. Senior fintech reporter, covers DeFi…"></textarea></div>
      </div>
      <div class="modal-actions">
        <button class="btn-danger" id="deleteBtn" onclick="deleteReporter()" style="display:none">Delete</button>
        <button class="btn-secondary" onclick="closeAdd()">Cancel</button>
        <button class="btn-primary" onclick="saveReporter()">Save Reporter</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ CONFERENCE ADD / EDIT MODAL ═══ -->
<div class="mb" id="confModal">
  <div class="md">
    <div class="mh"><h2 id="confModalTitle">+ Add Conference</h2><button class="mc" onclick="closeConf()">✕</button></div>
    <div class="mb-body">
      <div class="form-grid">
        <div class="field full"><label>Event Name *</label><input id="cf-name" type="text" placeholder="Money 20/20"></div>
        <div class="field"><label>Start Date *</label><input id="cf-start" type="date"></div>
        <div class="field"><label>End Date</label><input id="cf-end" type="date"></div>
        <div class="field"><label>Audience</label>
          <select id="cf-audience"><option value="">— select —</option><option>Developers</option><option>Enterprises</option><option>Investors</option><option>Developers & Enterprises</option><option>Enterprises & Investors</option><option>All</option></select>
        </div>
        <div class="field"><label>Organizer Contact</label><input id="cf-organizer" type="text" placeholder="Name / email / company"></div>
        <div class="field full">
          <label>Themes <span style="font-weight:400;text-transform:none;letter-spacing:0">(type & press Enter or comma)</span></label>
          <div class="tag-input-wrap" id="confThemeTagWrap" onclick="document.getElementById('confThemeTagInput').focus()">
            <input type="text" id="confThemeTagInput" placeholder="e.g. DeFi, Payments, AI…">
          </div>
          <div class="tag-hint">Press Enter or comma to add each theme</div>
          <input type="hidden" id="cf-themes">
        </div>
        <div class="field full"><label>Notes</label><textarea id="cf-notes" placeholder="Location, cost, deadlines…"></textarea></div>
      </div>
      <div class="modal-actions">
        <button class="btn-danger" id="confDeleteBtn" onclick="deleteConf()" style="display:none">Delete</button>
        <button class="btn-secondary" onclick="closeConf()">Cancel</button>
        <button class="btn-primary" onclick="saveConf()">Save Event</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ BULK ADD MODAL ═══ -->
<div class="mb" id="bulkModal">
  <div class="md md-lg">
    <div class="mh"><h2>⊞ Bulk Add Reporters</h2><button class="mc" onclick="closeBulk()">✕</button></div>
    <div class="mb-body">
      <div class="bulk-info">
        Paste your list below — one reporter per line.<br>
        Column order: <code>Name</code> · <code>Email</code> · <code>Outlet</code> · <code>Tier</code> · <code>Beat</code> · <code>Sector</code> · <code>Country</code> · <code>Type</code> · <code>Themes</code> · <code>Notes</code><br>
        <strong>Tip:</strong> Copy rows straight from Google Sheets or Excel. Only Name and Email are required. Themes can be semicolon-separated within a cell.
      </div>
      <div class="field">
        <label>Paste your list here</label>
        <textarea class="bulk-ta" id="bulkInput" placeholder="James Walker&#9;j.walker@ft.com&#9;Financial Times&#9;Tier 1&#9;Markets&#9;Finance&#9;UK&#9;Publication&#9;Fintech;DeFi&#9;Senior fintech reporter" oninput="parseBulk()"></textarea>
      </div>
      <div id="bulkPreview"></div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeBulk()">Cancel</button>
        <button class="btn-primary" id="bulkSaveBtn" onclick="saveBulk()" disabled>Import 0 Reporters</button>
      </div>
    </div>
  </div>
</div>


<!-- ═══ BULK ADD CONFERENCES MODAL ═══ -->
<div class="mb" id="confBulkModal">
  <div class="md md-lg">
    <div class="mh"><h2>⊞ Bulk Add Conferences</h2><button class="mc" onclick="closeConfBulk()">✕</button></div>
    <div class="mb-body">
      <div class="bulk-info">
        Paste your list below — one event per line.<br>
        Column order: <code>Event Name</code> · <code>Start Date</code> · <code>End Date</code> · <code>Audience</code> · <code>Themes</code> · <code>Organizer Contact</code> · <code>Notes</code><br>
        <strong>Tip:</strong> Copy rows straight from Google Sheets or Excel. Dates as YYYY-MM-DD or DD/MM/YYYY. Only Event Name is required.
      </div>
      <div class="field">
        <label>Paste your list here</label>
        <textarea class="bulk-ta" id="confBulkInput" placeholder="Money 20/20&#9;2026-10-22&#9;2026-10-25&#9;Enterprises, Investors&#9;Fintech, AI&#9;contact@money2020.com&#9;Annual fintech conference" oninput="parseConfBulk()"></textarea>
      </div>
      <div id="confBulkPreview"></div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeConfBulk()">Cancel</button>
        <button class="btn-primary" id="confBulkSaveBtn" onclick="saveConfBulk()" disabled>Import 0 Events</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SETUP MODAL ═══ -->
<div class="mb" id="setupModal">
  <div class="md md-xl">
    <div class="mh"><h2>⚙ &nbsp;Connect Shared Database</h2><button class="mc" onclick="closeSetup()">✕</button></div>
    <div class="mb-body">
      <div class="setup-note">
        This connects all team members to the same live reporter list. One person sets it up once — everyone else just needs the API key pasted in.
      </div>
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-content">
          <h4>Create a free JSONBin account</h4>
          <p>Go to <strong>jsonbin.io</strong> → click <strong>Sign Up</strong> → use a team email so anyone can log in if needed.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-content">
          <h4>Get your API key</h4>
          <p>After signing in, click your profile icon → <strong>API Keys</strong> → copy the <strong>Master Key</strong> (starts with <code>$2b$</code>…).</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-content">
          <h4>Paste your Master Key below</h4>
          <p>The app will create a private bin automatically and store the database there. Share the key with teammates so they can connect their own copy.</p>
          <div class="key-wrap">
            <input type="password" id="apiKeyInput" placeholder="$2b$10$…paste your JSONBin master key…" autocomplete="off">
            <button class="btn-connect" onclick="connectDB()">Connect</button>
          </div>
          <div class="conn-status" id="connStatus"></div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">4</div>
        <div class="step-content">
          <h4>Share with your team</h4>
          <p>Share the hosted URL of this app and the JSONBin Master Key. Teammates paste the key once and are instantly on the same live list.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════
const JSONBIN_BASE = 'https://api.jsonbin.io/v3';
const LOCAL_KEY    = 'fb_pr_v4';
const CACHE_KEY    = 'fb_pr_cache_v4';

// ═══════════════════════════════════════════════════════
// CREDENTIAL STORAGE
// ═══════════════════════════════════════════════════════
function getCreds(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY))||{}; }catch{ return {}; } }
function saveCreds(obj){ localStorage.setItem(LOCAL_KEY, JSON.stringify(obj)); }
function getCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY))||{reporters:[],conferences:[]}; }catch{ return {reporters:[],conferences:[]}; } }
function saveCache(d){ localStorage.setItem(CACHE_KEY, JSON.stringify(d)); }

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let DB = { reporters: [], conferences: [] };
let isSaving = false;
const F = { tiers:new Set(), beats:new Set(), sectors:new Set(), countries:new Set(), types:new Set(), search:'' };
const CF = { months:new Set(), audiences:new Set(), themes:new Set(), search:'' };
let editingId = null;
let confEditingId = null;
let bulkParsed = [];
let currentTab = 'reporters';

// tag inputs state
let reporterTags = [];
let confTags = [];

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

// ═══════════════════════════════════════════════════════
// TAB SWITCHING
// ═══════════════════════════════════════════════════════
function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('page-'+tab).classList.add('active');

  if(tab==='reporters'){
    document.getElementById('bulkBtn').style.display='';
    document.getElementById('bulkBtn').textContent='⊞ Bulk Add';
    document.getElementById('bulkBtn').onclick=openBulk;
    document.getElementById('addBtn').textContent='+ Add Reporter';
    document.getElementById('addBtn').onclick=openAdd;
    document.getElementById('exportBtn').onclick=exportAll;
    document.getElementById('totalBadge').textContent=DB.reporters.length+' reporters';
  } else {
    document.getElementById('bulkBtn').style.display='';
    document.getElementById('bulkBtn').textContent='⊞ Bulk Add';
    document.getElementById('bulkBtn').onclick=openConfBulk;
    document.getElementById('addBtn').textContent='+ Add Conference';
    document.getElementById('addBtn').onclick=openConf;
    document.getElementById('exportBtn').onclick=exportConfAll;
    document.getElementById('totalBadge').textContent=DB.conferences.length+' events';
  }
}

// ═══════════════════════════════════════════════════════
// TAG INPUT WIDGET
// ═══════════════════════════════════════════════════════
function initTagInput(wrapId, inputId, hiddenId, tagsArr){
  const wrap  = document.getElementById(wrapId);
  const input = document.getElementById(inputId);
  const hidden= document.getElementById(hiddenId);

  // clear existing tags
  wrap.querySelectorAll('.ti-tag').forEach(t=>t.remove());
  tagsArr.length=0;

  function addTag(val){
    val = val.trim().replace(/,$/,'').trim();
    if(!val || tagsArr.includes(val)) return;
    tagsArr.push(val);
    const span = document.createElement('span');
    span.className='ti-tag';
    span.innerHTML=`${x(val)}<button type="button" onclick="removeTag('${wrapId}','${inputId}','${hiddenId}',this,'${val.replace(/'/g,"\\'")}',${wrapId==='themeTagWrap'?'reporterTags':'confTags'})">×</button>`;
    wrap.insertBefore(span,input);
    hidden.value=tagsArr.join(',');
    input.value='';
  }

  input.onkeydown=e=>{
    if((e.key==='Enter'||e.key===',')&&input.value.trim()){e.preventDefault();addTag(input.value);}
    if(e.key==='Backspace'&&!input.value&&tagsArr.length){
      const last=tagsArr[tagsArr.length-1];
      removeTag(wrapId,inputId,hiddenId,null,last,tagsArr);
    }
  };
  input.oninput=()=>{ if(input.value.endsWith(',')){ addTag(input.value); } };
}

function removeTag(wrapId,inputId,hiddenId,btn,val,arr){
  // arr might be passed as the array reference via onclick string — re-resolve
  const tagsArr = (wrapId==='themeTagWrap')?reporterTags:confTags;
  const idx=tagsArr.indexOf(val);
  if(idx>-1) tagsArr.splice(idx,1);
  // remove the span
  const wrap=document.getElementById(wrapId);
  wrap.querySelectorAll('.ti-tag').forEach(sp=>{
    if(sp.textContent.replace('×','').trim()===val) sp.remove();
  });
  document.getElementById(hiddenId).value=tagsArr.join(',');
}

function loadTagsIntoInput(wrapId,inputId,hiddenId,tagsArr,values){
  initTagInput(wrapId,inputId,hiddenId,tagsArr);
  const input=document.getElementById(inputId);
  values.forEach(v=>{
    const wrap=document.getElementById(wrapId);
    const hidden=document.getElementById(hiddenId);
    if(!v||tagsArr.includes(v)) return;
    tagsArr.push(v);
    const span=document.createElement('span');
    span.className='ti-tag';
    span.innerHTML=`${x(v)}<button type="button" onclick="removeTag('${wrapId}','${inputId}','${hiddenId}',this,'${v.replace(/'/g,"\\'")}',null)">×</button>`;
    wrap.insertBefore(span,input);
    hidden.value=tagsArr.join(',');
  });
}

// ═══════════════════════════════════════════════════════
// JSONBIN API
// ═══════════════════════════════════════════════════════
async function apiGet(path,key){ const r=await fetch(JSONBIN_BASE+path,{headers:{'X-Master-Key':key}}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
async function apiPost(path,key,body){ const r=await fetch(JSONBIN_BASE+path,{method:'POST',headers:{'X-Master-Key':key,'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
async function apiPut(path,key,body){ const r=await fetch(JSONBIN_BASE+path,{method:'PUT',headers:{'X-Master-Key':key,'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }

// ═══════════════════════════════════════════════════════
// CONNECT
// ═══════════════════════════════════════════════════════
async function connectDB(){
  const key = document.getElementById('apiKeyInput').value.trim();
  if(!key){ setConnStatus('Please paste your Master Key','err'); return; }
  setConnStatus('Connecting…','');
  setSyncPill('saving','Connecting…');
  try {
    const creds = getCreds();
    if(creds.binId && creds.apiKey===key){
      const data = await apiGet(`/b/${creds.binId}/latest`,key);
      DB = normalizeDB(data.record);
      saveCache(DB);
      setConnStatus(`✓ Reconnected — ${DB.reporters.length} reporters loaded`,'ok');
      finishConnect(key,creds.binId); return;
    }
    const res = await apiPost('/b',key,{ reporters:SEED_DATA, conferences:SEED_CONFERENCES, meta:{app:'hokku_pr_v2',created:new Date().toISOString()} });
    const binId = res.metadata.id;
    DB = { reporters:SEED_DATA, conferences:SEED_CONFERENCES };
    saveCache(DB);
    saveCreds({apiKey:key,binId});
    setConnStatus(`✓ Database created — ${DB.reporters.length} reporters loaded`,'ok');
    finishConnect(key,binId);
  } catch(err){
    setConnStatus(`✗ ${err.message} — check your key and try again`,'err');
    setSyncPill('error','Connection failed');
  }
}

function normalizeDB(record){
  if(Array.isArray(record)) return {reporters:record, conferences:[]};
  return { reporters: record.reporters||[], conferences: record.conferences||[] };
}

function finishConnect(key,binId){
  saveCreds({apiKey:key,binId});
  closeSetup();
  setSyncPill('live',`Live · ${DB.reporters.length} reporters`);
  buildAllChips(); render(); buildConfChips(); renderConf();
  toast(`Connected — ${DB.reporters.length} reporters loaded`,'s');
}

function setConnStatus(msg,cls){
  const el=document.getElementById('connStatus');
  el.textContent=msg; el.className='conn-status '+cls;
}




// ═══════════════════════════════════════════════════════
// MULTI-SELECT & BULK DELETE — REPORTERS
// ═══════════════════════════════════════════════════════
let selectedIds = new Set();

function toggleSelect(id, checked){
  checked ? selectedIds.add(id) : selectedIds.delete(id);
  updateSelectionUI();
}

function toggleSelectAll(){
  const all = document.getElementById('selectAll');
  const rows = filteredReporters();
  if(all.checked){ rows.forEach(r=>selectedIds.add(r.id)); }
  else { rows.forEach(r=>selectedIds.delete(r.id)); }
  updateSelectionUI();
  render();
}

function clearSelection(){
  selectedIds.clear();
  const sa = document.getElementById('selectAll');
  if(sa) sa.checked = false;
  updateSelectionUI();
  render();
}

function updateSelectionUI(){
  const bar = document.getElementById('bulkActionBar');
  const cnt = document.getElementById('selCount');
  if(selectedIds.size > 0){
    bar.classList.add('on');
    cnt.textContent = selectedIds.size;
  } else {
    bar.classList.remove('on');
  }
  // sync checkboxes in existing rows without re-rendering
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const cb = tr.querySelector('input[type=checkbox]');
    if(cb){
      const id = cb.getAttribute('onchange').match(/'([^']+)'/)?.[1];
      if(id){ const sel = selectedIds.has(id); cb.checked = sel; tr.classList.toggle('selected', sel); }
    }
  });
  const rows = filteredReporters();
  const sa = document.getElementById('selectAll');
  if(sa) sa.checked = rows.length > 0 && rows.every(r=>selectedIds.has(r.id));
}

function askDeleteSelected(){
  document.getElementById('selNormal').style.display='none';
  document.getElementById('selConfirm').style.display='flex';
}
function cancelDeleteSelected(){
  document.getElementById('selNormal').style.display='flex';
  document.getElementById('selConfirm').style.display='none';
}
function deleteSelected(){
  if(!selectedIds.size) return;
  const count = selectedIds.size;
  DB.reporters = DB.reporters.filter(r=>!selectedIds.has(r.id));
  selectedIds.clear();
  scheduleSave(); buildAllChips(); render();
  document.getElementById('bulkActionBar').classList.remove('on');
  document.getElementById('selNormal').style.display='flex';
  document.getElementById('selConfirm').style.display='none';
  const sa = document.getElementById('selectAll');
  if(sa) sa.checked = false;
  toast(`Deleted ${count} reporter${count>1?'s':''}`, 'w');
}

// ═══════════════════════════════════════════════════════
// MULTI-SELECT & BULK DELETE — CONFERENCES
// ═══════════════════════════════════════════════════════
let confSelectedIds = new Set();

function toggleConfSelect(id, checked){
  checked ? confSelectedIds.add(id) : confSelectedIds.delete(id);
  updateConfSelectionUI();
}

function toggleConfSelectAll(){
  const all = document.getElementById('confSelectAll');
  const rows = filteredConfs();
  if(all.checked){ rows.forEach(c=>confSelectedIds.add(c.id)); }
  else { rows.forEach(c=>confSelectedIds.delete(c.id)); }
  updateConfSelectionUI();
  renderConf();
}

function clearConfSelection(){
  confSelectedIds.clear();
  const sa = document.getElementById('confSelectAll');
  if(sa) sa.checked = false;
  updateConfSelectionUI();
  renderConf();
}

function updateConfSelectionUI(){
  const bar = document.getElementById('confBulkActionBar');
  const cnt = document.getElementById('confSelCount');
  if(confSelectedIds.size > 0){
    bar.classList.add('on');
    cnt.textContent = confSelectedIds.size;
  } else {
    bar.classList.remove('on');
  }
  document.querySelectorAll('#confTbody tr').forEach(tr=>{
    const cb = tr.querySelector('input[type=checkbox]');
    if(cb){
      const id = cb.getAttribute('onchange').match(/'([^']+)'/)?.[1];
      if(id){ const sel = confSelectedIds.has(id); cb.checked = sel; tr.classList.toggle('selected', sel); }
    }
  });
  const rows = filteredConfs();
  const sa = document.getElementById('confSelectAll');
  if(sa) sa.checked = rows.length > 0 && rows.every(c=>confSelectedIds.has(c.id));
}

function askDeleteConfSelected(){
  document.getElementById('confSelNormal').style.display='none';
  document.getElementById('confSelConfirm').style.display='flex';
}
function cancelDeleteConfSelected(){
  document.getElementById('confSelNormal').style.display='flex';
  document.getElementById('confSelConfirm').style.display='none';
}
function deleteConfSelected(){
  if(!confSelectedIds.size) return;
  const count = confSelectedIds.size;
  DB.conferences = DB.conferences.filter(c=>!confSelectedIds.has(c.id));
  confSelectedIds.clear();
  scheduleSave(); buildConfChips(); renderConf();
  document.getElementById('confBulkActionBar').classList.remove('on');
  document.getElementById('confSelNormal').style.display='flex';
  document.getElementById('confSelConfirm').style.display='none';
  const sa = document.getElementById('confSelectAll');
  if(sa) sa.checked = false;
  toast(`Deleted ${count} event${count>1?'s':''}`, 'w');
}

// ═══════════════════════════════════════════════════════
// BULK ADD CONFERENCES
// ═══════════════════════════════════════════════════════
let confBulkParsed = [];

function openConfBulk(){
  document.getElementById('confBulkInput').value='';
  document.getElementById('confBulkPreview').innerHTML='';
  document.getElementById('confBulkSaveBtn').disabled=true;
  document.getElementById('confBulkSaveBtn').textContent='Import 0 Events';
  confBulkParsed=[];
  document.getElementById('confBulkModal').classList.add('on');
  setTimeout(()=>document.getElementById('confBulkInput').focus(),80);
}
function closeConfBulk(){ document.getElementById('confBulkModal').classList.remove('on'); }

function parseConfDate(raw){
  if(!raw) return '';
  raw=raw.trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
  const m=raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
  return raw;
}

function parseConfBulk(){
  const raw=document.getElementById('confBulkInput').value;
  const lines=raw.split('\n').map(l=>l.trim()).filter(l=>l);
  confBulkParsed=[]; const errs=[];
  lines.forEach((line,i)=>{
    const cols=line.includes('\t')?line.split('\t'):line.split(',');
    const [name,startRaw,endRaw,audience,themes,organizer,...rest]=cols.map(c=>c.trim().replace(/^"|"$/g,'').trim());
    const notes=rest.join(',').trim().replace(/^"|"$/g,'').trim();
    if(!name){ errs.push(`Row ${i+1}: missing event name`); return; }
    const startDate=parseConfDate(startRaw);
    const endDate=parseConfDate(endRaw);
    const month=startDate?MONTHS[new Date(startDate+' ').getMonth()]:'';
    confBulkParsed.push({id:uid(),name,startDate,endDate,month,audience:audience||'',themes:(themes||'').replace(/;/g,','),organizer:organizer||'',notes:notes||''});
  });
  const prev=document.getElementById('confBulkPreview');
  const btn=document.getElementById('confBulkSaveBtn');
  if(!lines.length){ prev.innerHTML=''; btn.disabled=true; btn.textContent='Import 0 Events'; return; }
  let h='';
  if(errs.length) h+=`<div class="preview-err">⚠ ${errs.join(' · ')}</div>`;
  if(confBulkParsed.length){
    h+=`<div class="preview-ok" style="margin-bottom:7px">✓ ${confBulkParsed.length} events ready to import</div>`;
    h+=`<table class="preview-table"><thead><tr><th>Event Name</th><th>Start</th><th>End</th><th>Audience</th><th>Themes</th></tr></thead><tbody>`;
    h+=confBulkParsed.slice(0,6).map(c=>`<tr><td>${x(c.name)}</td><td>${x(c.startDate)}</td><td>${x(c.endDate)}</td><td>${x(c.audience)}</td><td>${x(c.themes)}</td></tr>`).join('');
    if(confBulkParsed.length>6) h+=`<tr><td colspan="5" style="color:var(--steel);font-size:11px;padding:6px 9px">…and ${confBulkParsed.length-6} more</td></tr>`;
    h+=`</tbody></table>`;
    btn.disabled=false; btn.textContent=`Import ${confBulkParsed.length} Event${confBulkParsed.length!==1?'s':''}`;
  } else { btn.disabled=true; btn.textContent='Import 0 Events'; }
  prev.innerHTML=h;
}

function saveConfBulk(){
  if(!confBulkParsed.length) return;
  const fresh=confBulkParsed.filter(c=>!DB.conferences.some(d=>d.name.toLowerCase()===c.name.toLowerCase()&&d.startDate===c.startDate));
  const dupes=confBulkParsed.length-fresh.length;
  DB.conferences.push(...fresh); scheduleSave(); closeConfBulk(); buildConfChips(); renderConf();
  let msg=`Added ${fresh.length} event${fresh.length!==1?'s':''}`;
  if(dupes) msg+=` · Skipped ${dupes} duplicate${dupes>1?'s':''}`;
  toast(msg,'s');
}

// ═══════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════
async function bootLoad(){
  const creds=getCreds();
  if(!creds.apiKey||!creds.binId){
    const cached=getCache();
    if(cached.reporters&&cached.reporters.length){
      DB=normalizeDB(cached);
      setSyncPill('offline','Offline — cached data');
      buildAllChips(); render(); buildConfChips(); renderConf();
      toast('Showing cached data — open ⚙ to reconnect','w');
    } else {
      // No cache, no creds — load seed data so filters are visible immediately
      DB = { reporters: SEED_DATA, conferences: SEED_CONFERENCES };
      setSyncPill('offline','Not connected — demo data');
      buildAllChips(); render(); buildConfChips(); renderConf();
    }
    return;
  }
  const cached=getCache();
  if(cached.reporters&&cached.reporters.length){
    DB=normalizeDB(cached);
    setSyncPill('saving','Syncing…');
    buildAllChips(); render(); buildConfChips(); renderConf();
  }
  try {
    const data=await apiGet(`/b/${creds.binId}/latest`,creds.apiKey);
    DB=normalizeDB(data.record);
    saveCache(DB);
    setSyncPill('live',`Live · ${DB.reporters.length} reporters`);
    buildAllChips(); render(); buildConfChips(); renderConf();
  } catch(err){
    if(cached.reporters&&cached.reporters.length){
      setSyncPill('offline','Offline — cached data');
      toast('Could not reach server — showing last cached data','w');
    } else {
      setSyncPill('error','Connection error');
      toast('Connection failed — open ⚙ to reconnect','e');
    }
  }
}

// ═══════════════════════════════════════════════════════
// SAVE
// ═══════════════════════════════════════════════════════
let saveTimer;
function scheduleSave(){
  saveCache(DB);
  clearTimeout(saveTimer);
  saveTimer=setTimeout(pushToServer,800);
}
async function pushToServer(){
  const creds=getCreds();
  if(!creds.apiKey||!creds.binId) return;
  isSaving=true;
  setSyncPill('saving','Saving…');
  try {
    await apiPut(`/b/${creds.binId}`,creds.apiKey,{ reporters:DB.reporters, conferences:DB.conferences });
    setSyncPill('live',`Live · ${DB.reporters.length} reporters`);
  } catch(err){
    setSyncPill('error','Save failed');
    toast('Could not save — check your connection','e');
  }
  isSaving=false;
}

function setSyncPill(cls,label){
  const el=document.getElementById('syncPill');
  el.className='sync-pill '+cls;
  document.getElementById('syncLabel').textContent=label;
}

// ═══════════════════════════════════════════════════════
// REPORTER CHIPS / FILTERS
// ═══════════════════════════════════════════════════════
function uniqTags(arr,key){ const all=[]; arr.forEach(r=>(r[key]||'').split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>all.push(t))); return [...new Set(all)].sort(); }

// Hardcoded filter lists — always fixed regardless of data
const OUTLET_TYPES = ['Publication','Podcast','Broadcast','Magazine','Newsletter'];
const BEATS        = ['Funding','Product Launch','Market'];
const SECTORS      = ['AI','Business','Crypto','Finance','News','Technology'];
const COUNTRIES    = ['France','Germany','Hong Kong','Japan','Singapore','South Korea','Switzerland','Thailand','UAE','UK','US','Other'];
const TIERS        = ['Tier 1','Tier 2','Tier 3'];

function buildAllChips(){
  buildChips('tierChips',   TIERS,                            F.tiers);
  buildChips('beatChips',   BEATS,                            F.beats);
  buildChips('sectorChips', SECTORS,                          F.sectors);
  buildChips('countryChips',COUNTRIES,                        F.countries);
  buildChips('typeChips',   OUTLET_TYPES,                     F.types);
}

function buildChips(id,vals,set){
  const el=document.getElementById(id); el.innerHTML='';
  const a=mkChip('All','__all__',true);
  a.onclick=()=>{ set.clear(); syncC(el,set); render(); };
  el.appendChild(a);
  vals.forEach(v=>{
    const c=mkChip(v,v,false);
    c.onclick=()=>{ set.has(v)?set.delete(v):set.add(v); syncC(el,set); render(); };
    el.appendChild(c);
  });
}
function mkChip(label,val,isAll){
  const d=document.createElement('div');
  d.className='chip'+(isAll?' all on':'');
  d.textContent=label; d.dataset.v=val; return d;
}
function syncC(el,set){
  el.querySelectorAll('.chip').forEach(c=>{
    c.dataset.v==='__all__'?c.classList.toggle('on',set.size===0):c.classList.toggle('on',set.has(c.dataset.v));
  });
}

// ═══════════════════════════════════════════════════════
// CONFERENCE CHIPS / FILTERS
// ═══════════════════════════════════════════════════════
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const CONF_AUDIENCES=['Developers','Enterprises','Investors','General Consumers'];
const CONF_THEMES=['AI','Web3','Fintech','Crypto','Institutional'];

function buildConfChips(){
  const usedMonths=[...new Set(DB.conferences.map(c=>c.month).filter(Boolean))].sort((a,b)=>MONTHS.indexOf(a)-MONTHS.indexOf(b));
  buildConfChipSet('confMonthChips',   usedMonths,   CF.months,    ()=>renderConf());
  buildConfChipSet('confAudienceChips',CONF_AUDIENCES,CF.audiences,()=>renderConf());
  buildConfChipSet('confThemeChips',   CONF_THEMES,  CF.themes,    ()=>renderConf());
}

function buildConfChipSet(id,vals,set,cb){
  const el=document.getElementById(id); el.innerHTML='';
  const a=mkChip('All','__all__',true);
  a.onclick=()=>{ set.clear(); syncC(el,set); cb(); };
  el.appendChild(a);
  vals.forEach(v=>{
    const c=mkChip(v,v,false);
    c.onclick=()=>{ set.has(v)?set.delete(v):set.add(v); syncC(el,set); cb(); };
    el.appendChild(c);
  });
}

// ═══════════════════════════════════════════════════════
// REPORTER FILTER + RENDER
// ═══════════════════════════════════════════════════════
function filteredReporters(){
  const q=F.search.toLowerCase();
  return DB.reporters.filter(r=>{
    if(F.tiers.size    && ![...F.tiers].some(t=>(r.tier||'').trim().toLowerCase()===t.toLowerCase())) return false;
    if(F.beats.size){
      const beatKeywords={'Funding':['funding'],'Product Launch':['product'],'Market':['market']};
      const rb=(r.beat||'').toLowerCase();
      if(![...F.beats].some(b=>(beatKeywords[b]||[b.toLowerCase()]).some(kw=>rb.includes(kw)))) return false;
    }
    if(F.sectors.size  && !F.sectors.has(r.sector)) return false;
    if(F.countries.size && ![...F.countries].some(c=>(r.country||'').trim().toLowerCase()===c.toLowerCase())) return false;
    if(F.types.size    && ![...F.types].some(t=>(r.type||'').trim().toLowerCase()===t.toLowerCase())) return false;
    if(q&&![r.name,r.email,r.outlet,r.sector,r.country,r.type,r.notes,r.beat,r.tier,r.themes]
           .some(f=>f&&f.toLowerCase().includes(q))) return false;
    return true;
  });
}

function render(){
  const rows=filteredReporters();
  document.getElementById('matchCount').textContent=rows.length;
  document.getElementById('totalBadge').textContent=(currentTab==='reporters'?DB.reporters.length+' reporters':DB.conferences.length+' events');

  const pills=document.getElementById('activePills'); pills.innerHTML='';
  [...F.tiers,...F.beats,...F.sectors,...F.countries,...F.types].forEach(v=>{
    const p=document.createElement('span'); p.className='pill'; p.textContent=v; pills.appendChild(p);
  });
  if(F.search){ const p=document.createElement('span'); p.className='pill'; p.textContent=`"${F.search}"`; pills.appendChild(p); }

  const empty=document.getElementById('emptyState');
  const tbl  =document.getElementById('tbl');
  if(rows.length===0){
    empty.classList.add('on'); tbl.style.display='none';
    if(DB.reporters.length===0&&!getCreds().binId){
      document.getElementById('emptyTitle').textContent='Not connected yet';
      document.getElementById('emptyMsg').textContent='Click ⚙ in the top right to connect your shared database.';
    } else if(DB.reporters.length===0){
      document.getElementById('emptyTitle').textContent='No reporters yet';
      document.getElementById('emptyMsg').textContent='Click + Add Reporter or ⊞ Bulk Add to get started.';
    } else {
      document.getElementById('emptyTitle').textContent='No reporters match';
      document.getElementById('emptyMsg').textContent='Try broadening your filters or clearing the search.';
    }
    return;
  }
  empty.classList.remove('on'); tbl.style.display='';

  document.getElementById('tbody').innerHTML=rows.map(r=>{
    const tierCls=r.tier==='Tier 1'?'tier1':r.tier==='Tier 2'?'tier2':'tier3';
    const isSel=selectedIds.has(r.id);
    return `<tr class="${isSel?'selected':''}">
      <td class="cb-cell"><input type="checkbox" ${isSel?"checked":""} onchange="toggleSelect('${r.id}',this.checked)"></td>
      <td>${x(r.outlet)}</td>
      <td class="n">${x(r.name)}</td>
      <td class="em">${x(r.email)}</td>
      <td>${r.tier?`<span class="tag ${tierCls}">${x(r.tier)}</span>`:'—'}</td>
      <td>${r.beat?`<span class="tag tp">${x(r.beat)}</span>`:'—'}</td>
      <td>${r.sector?`<span class="tag ts">${x(r.sector)}</span>`:'—'}</td>
      <td>${r.type?`<span class="tag tt">${x(r.type)}</span>`:'—'}</td>
      <td>${r.country?`<span class="tag tc">${x(r.country)}</span>`:'—'}</td>
      <td class="nt">${x(r.notes)}</td>
      <td><div class="act-btns">
        <button class="act-btn btn-edit" onclick="openEdit('${r.id}')">Edit</button>
        <button class="act-btn btn-del"  onclick="confirmDel('${r.id}')">✕</button>
      </div></td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════
// CONFERENCE FILTER + RENDER
// ═══════════════════════════════════════════════════════
function filteredConfs(){
  const q=CF.search.toLowerCase();
  return DB.conferences.filter(c=>{
    if(CF.months.size    && !CF.months.has(c.month))       return false;
    if(CF.audiences.size){
      const ca=(c.audience||'').toLowerCase();
      if(![...CF.audiences].some(a=>ca.includes(a.toLowerCase()))) return false;
    }
    if(CF.themes.size){
      const ct=(c.themes||'').toLowerCase();
      if(![...CF.themes].some(t=>ct.includes(t.toLowerCase()))) return false;
    }
    if(q&&![c.name,c.organizer,c.notes,c.audience,c.themes,c.month]
           .some(f=>f&&f.toLowerCase().includes(q))) return false;
    return true;
  }).sort((a,b)=>{
    if(!a.startDate&&!b.startDate) return 0;
    if(!a.startDate) return 1; if(!b.startDate) return -1;
    return new Date(a.startDate)-new Date(b.startDate);
  });
}

function renderConf(){
  const rows=filteredConfs();
  document.getElementById('confMatchCount').textContent=rows.length;

  const pills=document.getElementById('confActivePills'); pills.innerHTML='';
  [...CF.months,...CF.audiences,...CF.themes].forEach(v=>{
    const p=document.createElement('span'); p.className='pill'; p.textContent=v; pills.appendChild(p);
  });
  if(CF.search){ const p=document.createElement('span'); p.className='pill'; p.textContent=`"${CF.search}"`; pills.appendChild(p); }

  const empty=document.getElementById('confEmptyState');
  const tbl  =document.getElementById('confTbl');
  if(rows.length===0){
    empty.classList.add('on'); tbl.style.display='none';
    document.getElementById('confEmptyTitle').textContent=DB.conferences.length===0?'No conferences yet':'No events match';
    document.getElementById('confEmptyMsg').textContent=DB.conferences.length===0?'Click + Add Conference to log your first event.':'Try broadening your filters.';
    return;
  }
  empty.classList.remove('on'); tbl.style.display='';

  document.getElementById('confTbody').innerHTML=rows.map(c=>{
    const isSel=confSelectedIds.has(c.id);
    const themeTags=(c.themes||'').split(',').map(t=>t.trim()).filter(Boolean)
      .map(t=>`<span class="tag tq">${x(t)}</span>`).join('');
    const fmtDate=d=>{if(!d)return'—';const [y,m,dd]=d.split('-');return`${dd}/${m}/${y}`;};
    return `<tr class="${isSel?'selected':''}">
      <td class="cb-cell"><input type="checkbox" ${isSel?"checked":""} onchange="toggleConfSelect('${c.id}',this.checked)"></td>
      <td>${c.month?`<span class="tag tc">${x(c.month)}</span>`:'—'}</td>
      <td>${fmtDate(c.startDate)}</td>
      <td>${fmtDate(c.endDate)}</td>
      <td class="n">${x(c.name)}</td>
      <td>${c.audience?`<span class="tag tp">${x(c.audience)}</span>`:'—'}</td>
      <td><div class="tags-cell">${themeTags||'—'}</div></td>
      <td class="nt">${x(c.organizer)}</td>
      <td><div class="act-btns">
        <button class="act-btn btn-edit" onclick="openEditConf('${c.id}')">Edit</button>
        <button class="act-btn btn-del"  onclick="confirmDelConf('${c.id}')">✕</button>
      </div></td>
    </tr>`;
  }).join('');
}

const x=s=>s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';

// ═══════════════════════════════════════════════════════
// REPORTER ADD / EDIT
// ═══════════════════════════════════════════════════════
function openAdd(){
  editingId=null;
  document.getElementById('addModalTitle').textContent='+ Add Reporter';
  document.getElementById('deleteBtn').style.display='none';
  ['name','email','outlet','notes'].forEach(f=>document.getElementById('f-'+f).value='');
  ['tier','beat','sector','country','type'].forEach(f=>document.getElementById('f-'+f).value='');
  reporterTags=[];
  initTagInput('themeTagWrap','themeTagInput','f-themes',reporterTags);
  document.getElementById('addModal').classList.add('on');
  setTimeout(()=>document.getElementById('f-name').focus(),80);
}
function openEdit(id){
  const r=DB.reporters.find(d=>d.id===id); if(!r) return;
  editingId=id;
  document.getElementById('addModalTitle').textContent='Edit Reporter';
  document.getElementById('deleteBtn').style.display='';
  document.getElementById('deleteBtn').dataset.id=id;
  ['name','email','outlet','notes'].forEach(f=>document.getElementById('f-'+f).value=r[f]||'');
  ['tier','beat','sector','country','type'].forEach(f=>document.getElementById('f-'+f).value=r[f]||'');
  reporterTags=[];
  loadTagsIntoInput('themeTagWrap','themeTagInput','f-themes',reporterTags,(r.themes||'').split(',').map(t=>t.trim()).filter(Boolean));
  document.getElementById('addModal').classList.add('on');
}
function closeAdd(){ document.getElementById('addModal').classList.remove('on'); editingId=null; }

function saveReporter(){
  const name =document.getElementById('f-name').value.trim();
  const email=document.getElementById('f-email').value.trim();
  if(!name||!email){ toast('Name and Email are required','e'); return; }
  const obj={
    id:editingId||uid(), name, email,
    outlet:  document.getElementById('f-outlet').value.trim(),
    tier:    document.getElementById('f-tier').value,
    beat:    document.getElementById('f-beat').value,
    sector:  document.getElementById('f-sector').value,
    country: document.getElementById('f-country').value,
    type:    document.getElementById('f-type').value,
    themes:  document.getElementById('f-themes').value,
    notes:   document.getElementById('f-notes').value.trim(),
  };
  if(editingId){ const i=DB.reporters.findIndex(r=>r.id===editingId); DB.reporters[i]=obj; }
  else DB.reporters.push(obj);
  scheduleSave(); closeAdd(); buildAllChips(); render();
  toast(editingId?`Updated ${name}`:`Added ${name}`,'s');
}

function confirmDel(id){
  const r=DB.reporters.find(d=>d.id===id); if(!r) return;
  if(confirm(`Delete ${r.name}? This cannot be undone.`)){ DB.reporters=DB.reporters.filter(d=>d.id!==id); scheduleSave(); closeAdd(); buildAllChips(); render(); toast('Reporter deleted','w'); }
}
function deleteReporter(){ confirmDel(document.getElementById('deleteBtn').dataset.id); }

// ═══════════════════════════════════════════════════════
// CONFERENCE ADD / EDIT
// ═══════════════════════════════════════════════════════
function openConf(){
  confEditingId=null;
  document.getElementById('confModalTitle').textContent='+ Add Conference';
  document.getElementById('confDeleteBtn').style.display='none';
  ['name','organizer','notes'].forEach(f=>document.getElementById('cf-'+f).value='');
  ['start','end'].forEach(f=>document.getElementById('cf-'+f).value='');
  document.getElementById('cf-audience').value='';
  confTags=[];
  initTagInput('confThemeTagWrap','confThemeTagInput','cf-themes',confTags);
  document.getElementById('confModal').classList.add('on');
  setTimeout(()=>document.getElementById('cf-name').focus(),80);
}
function openEditConf(id){
  const c=DB.conferences.find(d=>d.id===id); if(!c) return;
  confEditingId=id;
  document.getElementById('confModalTitle').textContent='Edit Conference';
  document.getElementById('confDeleteBtn').style.display='';
  document.getElementById('confDeleteBtn').dataset.id=id;
  document.getElementById('cf-name').value=c.name||'';
  document.getElementById('cf-start').value=c.startDate||'';
  document.getElementById('cf-end').value=c.endDate||'';
  document.getElementById('cf-audience').value=c.audience||'';
  document.getElementById('cf-organizer').value=c.organizer||'';
  document.getElementById('cf-notes').value=c.notes||'';
  confTags=[];
  loadTagsIntoInput('confThemeTagWrap','confThemeTagInput','cf-themes',confTags,(c.themes||'').split(',').map(t=>t.trim()).filter(Boolean));
  document.getElementById('confModal').classList.add('on');
}
function closeConf(){ document.getElementById('confModal').classList.remove('on'); confEditingId=null; }

function saveConf(){
  const name=document.getElementById('cf-name').value.trim();
  const startDate=document.getElementById('cf-start').value;
  if(!name||!startDate){ toast('Event Name and Start Date are required','e'); return; }
  const month=startDate?MONTHS[new Date(startDate+' ').getMonth()]:'';
  const obj={
    id:confEditingId||uid(), name, startDate,
    endDate:   document.getElementById('cf-end').value,
    month,
    audience:  document.getElementById('cf-audience').value,
    organizer: document.getElementById('cf-organizer').value.trim(),
    themes:    document.getElementById('cf-themes').value,
    notes:     document.getElementById('cf-notes').value.trim(),
  };
  if(confEditingId){ const i=DB.conferences.findIndex(c=>c.id===confEditingId); DB.conferences[i]=obj; }
  else DB.conferences.push(obj);
  scheduleSave(); closeConf(); buildConfChips(); renderConf();
  toast(confEditingId?`Updated ${name}`:`Added ${name}`,'s');
}

function confirmDelConf(id){
  const c=DB.conferences.find(d=>d.id===id); if(!c) return;
  if(confirm(`Delete "${c.name}"? This cannot be undone.`)){ DB.conferences=DB.conferences.filter(d=>d.id!==id); scheduleSave(); buildConfChips(); renderConf(); toast('Event deleted','w'); }
}
function deleteConf(){ confirmDelConf(document.getElementById('confDeleteBtn').dataset.id); }

// ═══════════════════════════════════════════════════════
// BULK ADD (reporters only)
// ═══════════════════════════════════════════════════════
function openBulk(){
  document.getElementById('bulkInput').value='';
  document.getElementById('bulkPreview').innerHTML='';
  document.getElementById('bulkSaveBtn').disabled=true;
  document.getElementById('bulkSaveBtn').textContent='Import 0 Reporters';
  bulkParsed=[];
  document.getElementById('bulkModal').classList.add('on');
  setTimeout(()=>document.getElementById('bulkInput').focus(),80);
}
function closeBulk(){ document.getElementById('bulkModal').classList.remove('on'); }

// ── Smart column sniffers ──
const KNOWN_TIERS    = ['tier 1','tier 2','tier 3'];
const KNOWN_TYPES    = ['publication','podcast','broadcast','magazine','newsletter'];
const KNOWN_BEATS_KW = ['funding','product','market','launch'];
const KNOWN_COUNTRIES= ['france','germany','uk','uae','us','usa','singapore','japan','hong kong','south korea','switzerland','thailand','other'];
// Sectors matched by inclusion so "Crypto Trade", "Crypto News" etc. all map to Crypto
const KNOWN_SECTORS  = ['crypto','fintech','finance','business','technology','news','mainstream','markets','ai'];

function sniffCol(val){
  const v=val.toLowerCase().trim();
  if(v.includes('@')) return 'email';
  if(KNOWN_TIERS.some(t=>v===t)) return 'tier';
  if(KNOWN_TYPES.some(t=>v===t)) return 'type';
  if(KNOWN_BEATS_KW.some(k=>v.includes(k))) return 'beat';
  if(KNOWN_COUNTRIES.some(c=>v===c||v.startsWith(c+' ')||v.endsWith(' '+c))) return 'country';
  // Sector: match by keyword inclusion so "Crypto Trade" -> crypto, "AI News" -> ai
  if(KNOWN_SECTORS.some(s=>v.includes(s))) return 'sector';
  // themes: comma/semicolon separated list
  if((v.includes(',') || v.includes(';')) && !v.includes('@')) return 'themes';
  return 'text';
}

// Normalise a sniffed sector value to the canonical chip label
function normaliseSector(val){
  const v=val.toLowerCase();
  if(v.includes('crypto'))  return 'Crypto';
  if(v.includes('fintech')) return 'Fintech';
  if(v.includes('finance')) return 'Finance';
  if(v.includes('tech'))    return 'Technology';
  if(v.includes('news'))    return 'News';
  if(v.includes('business'))return 'Business';
  if(v.includes('ai'))      return 'AI';
  return val; // fallback keep as-is
}

function parseBulk(){
  const raw=document.getElementById('bulkInput').value;
  const lines=raw.split('\n').map(l=>l.trim()).filter(l=>l);
  bulkParsed=[]; const errs=[];
  lines.forEach((line,i)=>{
    const cols=(line.includes('\t')?line.split('\t'):line.split(',')).map(c=>c.trim().replace(/^"|"$/g,'').trim());

    // Assign each column a role by sniffing its content
    const assigned = { email:'', tier:'', type:'', beat:'', country:'', sector:'', themes:'', notes:'' };
    const textCols = []; // unclassified — name, outlet, notes candidates

    cols.forEach(val=>{
      const role = sniffCol(val);
      if(role==='email' && !assigned.email)        assigned.email   = val;
      else if(role==='tier' && !assigned.tier)     assigned.tier    = val;
      else if(role==='type' && !assigned.type)     assigned.type    = val;
      else if(role==='beat' && !assigned.beat)     assigned.beat    = val;
      else if(role==='country' && !assigned.country) assigned.country = val;
      else if(role==='sector' && !assigned.sector) assigned.sector  = val;
      else if(role==='themes' && !assigned.themes) assigned.themes  = val;
      else textCols.push(val);
    });

    if(!assigned.email){ errs.push(`Row ${i+1}: no email found`); return; }

    // First text col = name, second = outlet, rest = notes
    const name   = textCols[0] || '';
    const outlet = textCols[1] || '';
    const notes  = textCols.slice(2).join(' ').trim();

    if(!name){ errs.push(`Row ${i+1}: missing name`); return; }

    bulkParsed.push({
      id:uid(), name, email:assigned.email, outlet,
      tier:assigned.tier, beat:assigned.beat, sector:assigned.sector?normaliseSector(assigned.sector):'',
      country:assigned.country, type:assigned.type,
      themes:assigned.themes.replace(/;/g,','), notes
    });
  });
  const prev=document.getElementById('bulkPreview');
  const btn =document.getElementById('bulkSaveBtn');
  if(!lines.length){ prev.innerHTML=''; btn.disabled=true; btn.textContent='Import 0 Reporters'; return; }
  let html='';
  if(errs.length) html+=`<div class="preview-err">⚠ ${errs.join(' · ')}</div>`;
  if(bulkParsed.length){
    html+=`<div class="preview-ok" style="margin-bottom:7px">✓ ${bulkParsed.length} reporters ready to import</div>`;
    html+=`<table class="preview-table"><thead><tr><th>Name</th><th>Email</th><th>Outlet</th><th>Tier</th><th>Beat</th><th>Themes</th></tr></thead><tbody>`;
    html+=bulkParsed.slice(0,6).map(r=>`<tr><td>${x(r.name)}</td><td>${x(r.email)}</td><td>${x(r.outlet)}</td><td>${x(r.tier)}</td><td>${x(r.beat)}</td><td>${x(r.themes)}</td></tr>`).join('');
    if(bulkParsed.length>6) html+=`<tr><td colspan="6" style="color:var(--steel);font-size:11px;padding:6px 9px">…and ${bulkParsed.length-6} more</td></tr>`;
    html+=`</tbody></table>`;
    btn.disabled=false; btn.textContent=`Import ${bulkParsed.length} Reporter${bulkParsed.length!==1?'s':''}`;
  } else { btn.disabled=true; btn.textContent='Import 0 Reporters'; }
  prev.innerHTML=html;
}

function saveBulk(){
  if(!bulkParsed.length) return;
  const fresh=bulkParsed.filter(r=>!DB.reporters.some(d=>d.email.toLowerCase()===r.email.toLowerCase()));
  const dupes=bulkParsed.length-fresh.length;
  DB.reporters.push(...fresh); scheduleSave(); closeBulk(); buildAllChips(); render();
  let msg=`Added ${fresh.length} reporters`;
  if(dupes) msg+=` · Skipped ${dupes} duplicate${dupes>1?'s':''}`;
  toast(msg,'s');
}

// ═══════════════════════════════════════════════════════
// CLEAR FILTERS
// ═══════════════════════════════════════════════════════
function clearAll(){
  F.tiers.clear(); F.beats.clear(); F.sectors.clear(); F.countries.clear(); F.types.clear(); F.search='';
  document.getElementById('searchInput').value='';
  ['tierChips','beatChips','sectorChips','countryChips','typeChips'].forEach(id=>{
    const map={tierChips:F.tiers,beatChips:F.beats,sectorChips:F.sectors,countryChips:F.countries,typeChips:F.types};
    syncC(document.getElementById(id),map[id]);
  });
  render();
}
function clearConfAll(){
  CF.months.clear(); CF.audiences.clear(); CF.themes.clear(); CF.search='';
  document.getElementById('confSearchInput').value='';
  ['confMonthChips','confAudienceChips','confThemeChips'].forEach(id=>{
    const map={confMonthChips:CF.months,confAudienceChips:CF.audiences,confThemeChips:CF.themes};
    syncC(document.getElementById(id),map[id]);
  });
  renderConf();
}

document.getElementById('searchInput').addEventListener('input',e=>{ F.search=e.target.value; render(); });
document.getElementById('confSearchInput').addEventListener('input',e=>{ CF.search=e.target.value; renderConf(); });

// ═══════════════════════════════════════════════════════
// EXPORT — REPORTERS
// ═══════════════════════════════════════════════════════
function exportCSV(){
  const rows=filteredReporters();
  if(!rows.length){ toast('No reporters to export','e'); return; }
  const h=['Name','Email','Outlet','Tier','Beat','Sector','Country','Type','Themes','Notes'];
  const csv=[h,...rows.map(r=>[r.name,r.email,r.outlet,r.tier,r.beat,r.sector,r.country,r.type,r.themes,r.notes])]
    .map(row=>row.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  dl(csv,'text/csv',`media_list_${today()}.csv`);
  toast(`Exported ${rows.length} reporters`,'s');
}
function exportAll(){
  const h=['Name','Email','Outlet','Tier','Beat','Sector','Country','Type','Themes','Notes'];
  const csv=[h,...DB.reporters.map(r=>[r.name,r.email,r.outlet,r.tier,r.beat,r.sector,r.country,r.type,r.themes,r.notes])]
    .map(row=>row.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  dl(csv,'text/csv',`media_list_BACKUP_${today()}.csv`);
  toast(`Full backup — ${DB.reporters.length} reporters`,'s');
}
function copyForSheets(){
  const rows=filteredReporters();
  if(!rows.length){ toast('No reporters to copy','e'); return; }
  const h=['Name','Email','Outlet','Tier','Beat','Sector','Country','Type','Themes','Notes'];
  const tsv=[h,...rows.map(r=>[r.name,r.email,r.outlet,r.tier,r.beat,r.sector,r.country,r.type,r.themes,r.notes])]
    .map(row=>row.map(v=>v||'').join('\t')).join('\n');
  navigator.clipboard.writeText(tsv)
    .then(()=>toast(`${rows.length} reporters copied — paste into Google Sheets`,'s'))
    .catch(()=>{ const ta=document.createElement('textarea'); ta.value=tsv; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast(`${rows.length} reporters copied`,'s'); });
}

// ═══════════════════════════════════════════════════════
// EXPORT — CONFERENCES
// ═══════════════════════════════════════════════════════
function exportConfCSV(){
  const rows=filteredConfs();
  if(!rows.length){ toast('No events to export','e'); return; }
  const h=['Month','Start Date','End Date','Event Name','Audience','Themes','Organizer Contact','Notes'];
  const csv=[h,...rows.map(c=>[c.month,c.startDate,c.endDate,c.name,c.audience,c.themes,c.organizer,c.notes])]
    .map(row=>row.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  dl(csv,'text/csv',`conferences_${today()}.csv`);
  toast(`Exported ${rows.length} events`,'s');
}
function exportConfAll(){
  const h=['Month','Start Date','End Date','Event Name','Audience','Themes','Organizer Contact','Notes'];
  const csv=[h,...DB.conferences.map(c=>[c.month,c.startDate,c.endDate,c.name,c.audience,c.themes,c.organizer,c.notes])]
    .map(row=>row.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  dl(csv,'text/csv',`conferences_BACKUP_${today()}.csv`);
  toast(`Backed up ${DB.conferences.length} events`,'s');
}
function copyConfForSheets(){
  const rows=filteredConfs();
  if(!rows.length){ toast('No events to copy','e'); return; }
  const h=['Month','Start Date','End Date','Event Name','Audience','Themes','Organizer Contact','Notes'];
  const tsv=[h,...rows.map(c=>[c.month,c.startDate,c.endDate,c.name,c.audience,c.themes,c.organizer,c.notes])]
    .map(row=>row.map(v=>v||'').join('\t')).join('\n');
  navigator.clipboard.writeText(tsv)
    .then(()=>toast(`${rows.length} events copied — paste into Google Sheets`,'s'))
    .catch(()=>{ const ta=document.createElement('textarea'); ta.value=tsv; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast(`${rows.length} events copied`,'s'); });
}

function dl(content,type,name){ const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([content],{type})),download:name}); a.click(); }
const today=()=>new Date().toISOString().slice(0,10);

// ═══════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════
let tt;
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast on ${type}`;
  clearTimeout(tt); tt=setTimeout(()=>t.classList.remove('on'),3800);
}

// ═══════════════════════════════════════════════════════
// SETUP MODAL
// ═══════════════════════════════════════════════════════
function openSetup(){
  const creds=getCreds();
  if(creds.apiKey) document.getElementById('apiKeyInput').value=creds.apiKey;
  document.getElementById('connStatus').textContent='';
  document.getElementById('setupModal').classList.add('on');
}
function closeSetup(){ document.getElementById('setupModal').classList.remove('on'); }

// ═══════════════════════════════════════════════════════
// CLOSE MODALS ON BACKGROUND CLICK
// ═══════════════════════════════════════════════════════
['addModal','bulkModal','setupModal','confModal','confBulkModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{
    if(e.target===e.currentTarget){
      if(id==='addModal') closeAdd();
      else if(id==='bulkModal') closeBulk();
      else if(id==='confModal') closeConf();
      else if(id==='confBulkModal') closeConfBulk();
      else closeSetup();
    }
  });
});

// ═══════════════════════════════════════════════════════
// SEED DATA
// ═══════════════════════════════════════════════════════
const SEED_DATA=[];

const SEED_CONFERENCES=[];



// BOOT
// ═══════════════════════════════════════════════════════
bootLoad();
</script>
</body>
</html>
